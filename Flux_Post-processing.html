
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Flux Post-processing &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Flux_Post-processing';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="markdown.html">Markdown Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks.html">Content with notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="markdown-notebooks.html">Notebooks with MyST Markdown</a></li>
<li class="toctree-l1"><a class="reference internal" href="text1.html">Text 1</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FFlux_Post-processing.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Flux_Post-processing.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Flux Post-processing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flux-processing-chain-notebooks">Flux processing chain notebooks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-2-quality-flag-expansion">Level 2: Quality flag expansion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general">General</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#individual-flags">Individual flags</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ssitc-test-flag"><strong>SSITC</strong> test flag</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gas-completeness-test-flag"><strong>Gas completeness</strong> test flag</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spectral-correction-factor-test-flag"><strong>Spectral correction factor</strong> test flag</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#signal-strength-test-flag"><strong>Signal strength</strong> test flag</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-data-screening-test-flags-multiple"><strong>Raw data screening</strong> test flags (multiple)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#angle-of-attack-aoa-flag"><strong>Angle-of-attack (AoA) flag</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#qcf-overall-quality-control-flag-after-level-2-tests">QCF: overall quality control flag after Level-2 tests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-1-storage-correction">Level 3.1: Storage correction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-2-outlier-removal">Level 3.2: Outlier removal</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#description-of-outlier-functions">Description of outlier functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-detection-settings">Outlier detection settings</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#nee-net-ecosystem-exchange-of-co2">NEE (net ecosystem exchange of CO<sub>2</sub>)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#le-latent-heat">LE (latent heat)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#h-sensible-heat">H (sensible heat)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fn2o-nitrous-oxide-flux">FN2O (nitrous oxide flux)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fch4-methane-flux">FCH4 (methane flux)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-3-ustar-filtering">Level 3.3: USTAR filtering</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#qcf-overall-quality-control-flag-after-level-3-3-tests">QCF: overall quality control flag after Level-3.3 tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-4-1-gap-filling">Level 4.1: Gap-filling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest">Random forest</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#features-predictors">Features (predictors)</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#nee-le-h">NEE, LE, H</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#fn2o-fch4">FN2O, FCH4</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-4-2-nee-partitioning-planned">Level 4.2: NEE Partitioning (planned)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#qcf-overall-quality-control-flag">QCF: overall quality control flag</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="flux-post-processing">
<h1>Flux Post-processing<a class="headerlink" href="#flux-post-processing" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Post-processing follows the <a class="reference external" href="https://www.swissfluxnet.ethz.ch/index.php/data/ecosystem-fluxes/flux-processing-chain/">Swiss Fluxnet Flux Processing Chain</a></p></li>
</ul>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span>flowchart
L1F[L1 fluxes]
L2QCF[L2 quality flags]
L31F[L3.1 fluxes]
L31Ffiltered[L3.1 fluxes filtered]
L32QCF[L3.2 quality flags]
L33QCF[L3.3 quality flags]
QCF[overall quality flag QCF]
L31FfilteredQCF[L3.1 fluxes filtered with QCF]
L41F[L4.1 gap-filled fluxes]
L42F[L4.2 partitioned fluxes]

L1F --&gt; L2QCF
L2QCF --&gt; L31Ffiltered
L1F --&gt; L31F
L31F --&gt; L31Ffiltered
L31Ffiltered --&gt; L32QCF
L1F --&gt; L33QCF

L2QCF --&gt; QCF
L32QCF --&gt; QCF
L33QCF --&gt; QCF

QCF -- applied to storage-corrected fluxes --&gt; L31FfilteredQCF
L31FfilteredQCF -- gap-filling --&gt; L41F

L41F -- partitioning (NEE) --&gt; L42F

</pre></div>
</div>
<ul class="simple">
<li><p><strong>Level-2</strong> creates additional quality flags that are then combined to one overall quality flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code> (quality control flag)</p></li>
<li><p><strong>Level-3.1</strong> adds the storage term to the respective flux</p></li>
<li><p><strong>Level-3.2</strong> detects outliers and creates additional quality flags</p></li>
<li><p><strong>Level-3.3</strong> creates additional quality flags based on three different constant USTAR thresholds, previously detected by FLUXNET (Pastorello et al., 2020)</p></li>
<li><p><strong>Level-4.1</strong> performs gap-filling (long-term random forest)</p></li>
<li><p>(planned) <strong>Level-4.2</strong> partitions NEE fluxes into GPP and RECO</p></li>
</ul>
</section>
<section id="flux-processing-chain-notebooks">
<h2>Flux processing chain notebooks<a class="headerlink" href="#flux-processing-chain-notebooks" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>NEE: <a class="reference internal" href="#../notebooks/40_FLUX_PROCESSING_CHAIN/41.0_FluxProcessingChain_L3.3_NEE_QCF10.ipynb"><span class="xref myst">41.0_FluxProcessingChain_L3.3_NEE_QCF10.ipynb</span></a></p></li>
<li><p>LE: <a class="reference internal" href="#../notebooks/40_FLUX_PROCESSING_CHAIN/42.0_FluxProcessingChain_L3.3_LE_QCF11.ipynb"><span class="xref myst">42.0_FluxProcessingChain_L3.3_LE_QCF11.ipynb</span></a></p></li>
<li><p>H: <a class="reference internal" href="#../notebooks/40_FLUX_PROCESSING_CHAIN/43.0_FluxProcessingChain_L3.3_H_QCF11.ipynb"><span class="xref myst">43.0_FluxProcessingChain_L3.3_H_QCF11.ipynb</span></a></p></li>
<li><p>N2O flux: <a class="reference internal" href="#../notebooks/50_FLUX_PROCESSING_CHAIN_QCL+LGR/51.0_FluxProcessingChain_L3.3_FN2O_QCF11.ipynb"><span class="xref myst">51.0_FluxProcessingChain_L3.3_FN2O_QCF11.ipynb</span></a></p></li>
<li><p>CH4 flux: <a class="reference internal" href="#../notebooks/50_FLUX_PROCESSING_CHAIN_QCL+LGR/52.0_FluxProcessingChain_L3.3_FCH4_QCF11.ipynb"><span class="xref myst">52.0_FluxProcessingChain_L3.3_FCH4_QCF11.ipynb</span></a></p></li>
</ul>
</section>
<section id="level-2-quality-flag-expansion">
<h2>Level 2: Quality flag expansion<a class="headerlink" href="#level-2-quality-flag-expansion" title="Link to this heading">#</a></h2>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span>flowchart LR
	L1[Level-1 fluxes] --&gt; d[quality flag expansion] --&gt; L2[Level-2 quality flags] --&gt; QCF[Level-2 overall quality flag QCF]
</pre></div>
</div>
<section id="general">
<h3>General<a class="headerlink" href="#general" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Level-2 creates additional quality flags.</strong></p></li>
<li><p>Based on Level-1 (final) flux calculations</p></li>
<li><p>Builds upon flux results (<em><em>fluxnet</em></em> files) from EddyPro</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">SSITC</span></code> flag from EddyPro is expanded with results from additional quality flags.</p></li>
<li><p>All individual quality flags are combined into one overall quality flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">QCF</span></code> flag uses a <code class="docutils literal notranslate"><span class="pre">0-1-2</span></code> system, where</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">0</span></code> = best quality data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">1</span></code> = medium quality data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2</span></code> = bad quality data, reject in all cases</p></li>
</ul>
</li>
</ul>
</section>
<section id="individual-flags">
<h3>Individual flags<a class="headerlink" href="#individual-flags" title="Link to this heading">#</a></h3>
<p><em>See notebooks for more details</em></p>
<section id="ssitc-test-flag">
<h4><strong>SSITC</strong> test flag<a class="headerlink" href="#ssitc-test-flag" title="Link to this heading">#</a></h4>
<ul>
<li><p>Combination of the two partial tests <em>steady state test</em> and <em>developed turbulent conditions test</em>, from EddyPro output. (Mauder and Foken, 2006)</p>
<ul>
<li><p>applied to: all fluxes</p></li>
<li><p><strong>Exception</strong>: flags where this test resulted in <code class="docutils literal notranslate"><span class="pre">1</span></code> were set to <code class="docutils literal notranslate"><span class="pre">2</span></code> during the time period between <code class="docutils literal notranslate"><span class="pre">2022-05-01</span></code> and <code class="docutils literal notranslate"><span class="pre">2023-09-30</span></code>.</p>
<ul class="simple">
<li><p>During this time period, there was a strange issue with the sonic anemometer where the vertical wind component <code class="docutils literal notranslate"><span class="pre">W_UNROT</span></code> (unrotated, the directly measured W) became  negative while during all other time periods the wind was more positive. NEE was clearly affected by this issue, showing some high uptake values during night, therefore also corrupting the gap-filling algorithm later on. Although this was not so visible during the day, we must assume that this effect was also present during daytime. We found that the most problematic time periods can be filtered out by setting the SSITC flag to <code class="docutils literal notranslate"><span class="pre">2</span></code> where the flag was <code class="docutils literal notranslate"><span class="pre">1</span></code>. Therefore we remove all flux values where the SSITC test was <code class="docutils literal notranslate"><span class="pre">1</span></code>. This issue is also visible in the second rotation angle <code class="docutils literal notranslate"><span class="pre">ROT_PITCH</span></code> with slightly different angles than before and after this period.</p></li>
</ul>
</li>
<li><p>Example output from diive for NEE (in this step still called <code class="docutils literal notranslate"><span class="pre">FC</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SSITC</span> <span class="n">TEST</span><span class="p">:</span> <span class="n">Generated</span> <span class="n">new</span> <span class="n">flag</span> <span class="n">variable</span> <span class="n">FLAG_L2_FC_SSITC_TEST</span><span class="p">,</span> <span class="n">values</span> <span class="n">taken</span> <span class="kn">from</span><span class="w"> </span><span class="nn">output</span> <span class="n">variable</span> <span class="n">FC_SSITC_TEST</span> <span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</section>
<section id="gas-completeness-test-flag">
<h4><strong>Gas completeness</strong> test flag<a class="headerlink" href="#gas-completeness-test-flag" title="Link to this heading">#</a></h4>
<ul>
<li><p>Check completeness of the variable that was used to calculate the respective flux, calculated in diive. (Sabbatini et al., 2018)</p>
<ul>
<li><p>applied to: all fluxes</p></li>
<li><p>Example output from diive for NEE (in this step still called <code class="docutils literal notranslate"><span class="pre">FC</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FLUX</span> <span class="n">BASE</span> <span class="n">VARIABLE</span> <span class="n">COMPLETENESS</span> <span class="n">TEST</span><span class="p">:</span> <span class="n">Generated</span> <span class="n">new</span> <span class="n">flag</span> <span class="n">variable</span> <span class="n">FLAG_L2_FC_COMPLETENESS_TEST</span><span class="p">,</span> <span class="n">newly</span> <span class="n">calculated</span> <span class="kn">from</span><span class="w"> </span><span class="nn">variable</span> <span class="n">CO2</span><span class="p">,</span> <span class="k">with</span> <span class="n">flag</span> <span class="mi">0</span> <span class="p">(</span><span class="n">good</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">available</span> <span class="n">number</span> <span class="n">of</span> <span class="n">records</span> <span class="k">for</span> <span class="n">CO2</span> <span class="o">&gt;=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">flag</span> <span class="mi">1</span> <span class="p">(</span><span class="n">ok</span> <span class="n">values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.97</span> <span class="ow">and</span> <span class="o">&lt;</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">flag</span> <span class="mi">2</span> <span class="p">(</span><span class="n">bad</span> <span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.97</span><span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</section>
<section id="spectral-correction-factor-test-flag">
<h4><strong>Spectral correction factor</strong> test flag<a class="headerlink" href="#spectral-correction-factor-test-flag" title="Link to this heading">#</a></h4>
<ul>
<li><p>using the <code class="docutils literal notranslate"><span class="pre">SCF</span></code> (spectral correction factor) from EddyPro output, then calculated in diive (Sabbatini et al., 2018)</p>
<ul>
<li><p>applied to: all fluxes</p></li>
<li><p>Example output from diive for NEE (in this step still called <code class="docutils literal notranslate"><span class="pre">FC</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SPECTRAL</span> <span class="n">CORRECTION</span> <span class="n">FACTOR</span> <span class="n">TEST</span><span class="p">:</span> <span class="n">Generating</span> <span class="n">new</span> <span class="n">flag</span> <span class="n">variable</span> <span class="n">FLAG_L2_FC_SCF_TEST</span><span class="p">,</span> <span class="n">newly</span> <span class="n">calculated</span> <span class="kn">from</span><span class="w"> </span><span class="nn">output</span> <span class="n">variable</span> <span class="n">FC_SCF</span><span class="p">,</span> <span class="n">withflag</span> <span class="mi">0</span> <span class="p">(</span><span class="n">good</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">FC_SCF</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">flag</span> <span class="mi">1</span> <span class="p">(</span><span class="n">ok</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">FC_SCF</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">flag</span> <span class="mi">2</span> <span class="p">(</span><span class="n">bad</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">FC_SCF</span> <span class="o">&gt;=</span> <span class="mf">4.</span><span class="o">..</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</section>
<section id="signal-strength-test-flag">
<h4><strong>Signal strength</strong> test flag<a class="headerlink" href="#signal-strength-test-flag" title="Link to this heading">#</a></h4>
<ul>
<li><p>for open path IRGAs, this test checks if the instrument’s <code class="docutils literal notranslate"><span class="pre">AGC</span></code> (automatic gain control, a measure of signal quality) is above a certain value, whereby high values stand for bad signal (note that for (en)closed path IRGAs it is typically the other way round with high values showing good signal strenth), fluxes where <code class="docutils literal notranslate"><span class="pre">AGC</span></code> was above 90% were discarded. In this case, the name of the custom variable was <code class="docutils literal notranslate"><span class="pre">CUSTOM_AGC_MEAN</span></code> and part of the EddyPro output files, the flag was then calculated in diive.</p>
<ul>
<li><p>applied to: open path IRGA fluxes (CO<sub>2</sub>, H<sub>2</sub>O)</p></li>
<li><p>Note that the water fluxes <code class="docutils literal notranslate"><span class="pre">LE</span></code> and <code class="docutils literal notranslate"><span class="pre">ET</span></code> are direct conversions of the calculated H<sub>2</sub>O flux</p></li>
<li><p>Example output from diive for NEE (in this step still called <code class="docutils literal notranslate"><span class="pre">FC</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SIGNAL</span> <span class="n">STRENGTH</span> <span class="n">TEST</span><span class="p">:</span> <span class="n">Generating</span> <span class="n">new</span> <span class="n">flag</span> <span class="n">variable</span> <span class="n">FLAG_L2_FC_SIGNAL_STRENGTH_TEST</span><span class="p">,</span> <span class="n">newly</span> <span class="n">calculated</span> <span class="kn">from</span><span class="w"> </span><span class="nn">output</span> <span class="n">variable</span> <span class="n">CUSTOM_AGC_MEAN</span><span class="p">,</span> <span class="k">with</span> <span class="n">flag</span> <span class="mi">0</span> <span class="p">(</span><span class="n">good</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">CUSTOM_AGC_MEAN</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">,</span> <span class="n">flag</span> <span class="mi">2</span> <span class="p">(</span><span class="n">bad</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">CUSTOM_AGC_MEAN</span> <span class="o">&gt;</span> <span class="mi">90</span> <span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</section>
<section id="raw-data-screening-test-flags-multiple">
<h4><strong>Raw data screening</strong> test flags (multiple)<a class="headerlink" href="#raw-data-screening-test-flags-multiple" title="Link to this heading">#</a></h4>
<ul>
<li><p>applied results from the EddyPro output file for spikes, amplitude and drop-outs, see also the official EddyPro help for more info <a class="reference external" href="https://www.licor.com/support/EddyPro/topics/despiking-raw-statistical-screening.html">here</a>. (Vickers and Mahrt, 1997)</p>
<ul>
<li><p>applied to: all fluxes</p></li>
<li><p>Example output from diive for NEE (in this step still called <code class="docutils literal notranslate"><span class="pre">FC</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RAW</span> <span class="n">DATA</span> <span class="n">TEST</span><span class="p">:</span> <span class="n">Generated</span> <span class="n">new</span> <span class="n">flag</span> <span class="n">variable</span> <span class="n">FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST</span><span class="p">,</span> <span class="n">values</span> <span class="n">taken</span> <span class="kn">from</span><span class="w"> </span><span class="nn">output</span> <span class="n">variable</span> <span class="n">CO2_VM97_TEST</span> <span class="kn">from</span><span class="w"> </span><span class="nn">position</span> <span class="mi">1</span><span class="p">,</span> <span class="n">based</span> <span class="n">on</span> <span class="n">CO2</span><span class="p">,</span> <span class="k">with</span> <span class="n">flag</span> <span class="mi">0</span> <span class="p">(</span><span class="n">good</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">passed</span><span class="p">,</span> <span class="n">flag</span> <span class="mi">2</span> <span class="p">(</span><span class="n">bad</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">failed</span> <span class="p">(</span><span class="k">for</span> <span class="n">hard</span> <span class="n">flags</span><span class="p">)</span> <span class="ow">or</span> <span class="n">flag</span> <span class="mi">1</span> <span class="p">(</span><span class="n">ok</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">failed</span> <span class="p">(</span><span class="k">for</span> <span class="n">soft</span> <span class="n">flags</span><span class="p">)</span> <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RAW</span> <span class="n">DATA</span> <span class="n">TEST</span><span class="p">:</span> <span class="n">Generated</span> <span class="n">new</span> <span class="n">flag</span> <span class="n">variable</span> <span class="n">FLAG_L2_FC_CO2_VM97_AMPLITUDE_RESOLUTION_HF_TEST</span><span class="p">,</span> <span class="n">values</span> <span class="n">taken</span> <span class="kn">from</span><span class="w"> </span><span class="nn">output</span> <span class="n">variable</span> <span class="n">CO2_VM97_TEST</span> <span class="kn">from</span><span class="w"> </span><span class="nn">position</span> <span class="mi">2</span><span class="p">,</span> <span class="n">based</span> <span class="n">on</span> <span class="n">CO2</span><span class="p">,</span> <span class="k">with</span> <span class="n">flag</span> <span class="mi">0</span> <span class="p">(</span><span class="n">good</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">passed</span><span class="p">,</span> <span class="n">flag</span> <span class="mi">2</span> <span class="p">(</span><span class="n">bad</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">failed</span> <span class="p">(</span><span class="k">for</span> <span class="n">hard</span> <span class="n">flags</span><span class="p">)</span> <span class="ow">or</span> <span class="n">flag</span> <span class="mi">1</span> <span class="p">(</span><span class="n">ok</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">failed</span> <span class="p">(</span><span class="k">for</span> <span class="n">soft</span> <span class="n">flags</span><span class="p">)</span> <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RAW</span> <span class="n">DATA</span> <span class="n">TEST</span><span class="p">:</span> <span class="n">Generated</span> <span class="n">new</span> <span class="n">flag</span> <span class="n">variable</span> <span class="n">FLAG_L2_FC_CO2_VM97_DROPOUT_TEST</span><span class="p">,</span> <span class="n">values</span> <span class="n">taken</span> <span class="kn">from</span><span class="w"> </span><span class="nn">output</span> <span class="n">variable</span> <span class="n">CO2_VM97_TEST</span> <span class="kn">from</span><span class="w"> </span><span class="nn">position</span> <span class="mi">3</span><span class="p">,</span> <span class="n">based</span> <span class="n">on</span> <span class="n">CO2</span><span class="p">,</span> <span class="k">with</span> <span class="n">flag</span> <span class="mi">0</span> <span class="p">(</span><span class="n">good</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">passed</span><span class="p">,</span> <span class="n">flag</span> <span class="mi">2</span> <span class="p">(</span><span class="n">bad</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">failed</span> <span class="p">(</span><span class="k">for</span> <span class="n">hard</span> <span class="n">flags</span><span class="p">)</span> <span class="ow">or</span> <span class="n">flag</span> <span class="mi">1</span> <span class="p">(</span><span class="n">ok</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">failed</span> <span class="p">(</span><span class="k">for</span> <span class="n">soft</span> <span class="n">flags</span><span class="p">)</span> <span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</section>
<section id="angle-of-attack-aoa-flag">
<h4><strong>Angle-of-attack (AoA) flag</strong><a class="headerlink" href="#angle-of-attack-aoa-flag" title="Link to this heading">#</a></h4>
<ul>
<li><p>The AoA flag was only applied during certain time periods:
- between <code class="docutils literal notranslate"><span class="pre">2008-01-01</span></code> and <code class="docutils literal notranslate"><span class="pre">2010-01-01</span></code>
- between <code class="docutils literal notranslate"><span class="pre">2016-03-01</span></code> and <code class="docutils literal notranslate"><span class="pre">2016-05-01</span></code>
- between <code class="docutils literal notranslate"><span class="pre">2021-12-10</span></code> and <code class="docutils literal notranslate"><span class="pre">2021-12-23</span></code></p>
<ul>
<li><p>All time periods when the flag indicated issues with AoA were flagged as bad data.</p></li>
<li><p>Normally not applied by default, but in this case there were time periods when the sonic’s vertical wind velocity produced unrealistic wind values.</p></li>
<li><p>applied to: all fluxes</p></li>
<li><p>Note: for flux calculations, the setting in EddyPro was relaxed and accepted minimum and maximum angles of attack of <code class="docutils literal notranslate"><span class="pre">-35°</span></code> and <code class="docutils literal notranslate"><span class="pre">+35°</span></code>, respectively, instead of the default <code class="docutils literal notranslate"><span class="pre">-30°</span></code> and <code class="docutils literal notranslate"><span class="pre">+30°</span></code>. Reason: this test is relatively strict and removes many data points, however, based on tests from another group the relaxed settings seemed defensible, especially since this flag was only applied to obviously flawed time periods.</p></li>
<li><p>Example output from diive for NEE (in this step still called <code class="docutils literal notranslate"><span class="pre">FC</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ANGLE</span> <span class="n">OF</span> <span class="n">ATTACK</span> <span class="n">TEST</span><span class="p">:</span> <span class="n">will</span> <span class="n">be</span> <span class="n">applied</span> <span class="n">on</span> <span class="n">the</span> <span class="n">following</span> <span class="n">dates</span> <span class="n">only</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;2008-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-01-01&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;2016-03-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-05-01&#39;</span><span class="p">]]</span>
<span class="n">ANGLE</span> <span class="n">OF</span> <span class="n">ATTACK</span> <span class="n">TEST</span><span class="p">:</span> <span class="n">Generated</span> <span class="n">new</span> <span class="n">flag</span> <span class="n">variable</span> <span class="n">FLAG_L2_FC_VM97_AOA_HF_TEST</span><span class="p">,</span> <span class="n">values</span> <span class="n">taken</span> <span class="kn">from</span><span class="w"> </span><span class="nn">output</span> <span class="n">variable</span> <span class="kc">None</span><span class="p">,</span> <span class="k">with</span> <span class="n">flag</span> <span class="mi">0</span> <span class="p">(</span><span class="n">good</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">passed</span><span class="p">,</span> <span class="n">flag</span> <span class="mi">2</span> <span class="p">(</span><span class="n">bad</span> <span class="n">values</span><span class="p">)</span> <span class="n">where</span> <span class="n">test</span> <span class="n">failed</span> <span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</section>
</section>
<section id="qcf-overall-quality-control-flag-after-level-2-tests">
<h3>QCF: overall quality control flag after Level-2 tests<a class="headerlink" href="#qcf-overall-quality-control-flag-after-level-2-tests" title="Link to this heading">#</a></h3>
<p><em>See below for a description of how <code class="docutils literal notranslate"><span class="pre">QCF</span></code> is calculated.</em></p>
<ul class="simple">
<li><p>**Single flags from Level-2 are combined into one quality control flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code> that is later <em>temporarily</em> applied before outlier detection tests (Level-3.2).</p></li>
</ul>
</section>
</section>
<section id="level-3-1-storage-correction">
<h2>Level 3.1: Storage correction<a class="headerlink" href="#level-3-1-storage-correction" title="Link to this heading">#</a></h2>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span>flowchart LR
	L1[Level-1 fluxes] --&gt; e[add storage term] --&gt; L3[Level-3.1 fluxes]
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Level-3.1 calculates storage-corrected fluxes.</strong></p></li>
<li><p>Added storage term from <em>single point measurement</em> to the respective flux</p></li>
<li><p>The storage term was calculated by EddyPro during flux calculations (Level-1)</p></li>
<li><p>Storage-corrected fluxes are: <code class="docutils literal notranslate"><span class="pre">NEE_L3.1</span></code> (from <code class="docutils literal notranslate"><span class="pre">FC</span></code>), <code class="docutils literal notranslate"><span class="pre">LE_L3.1</span></code> (from <code class="docutils literal notranslate"><span class="pre">LE</span></code>), <code class="docutils literal notranslate"><span class="pre">H_L3.1</span></code> (from <code class="docutils literal notranslate"><span class="pre">H</span></code>), <code class="docutils literal notranslate"><span class="pre">FN2O_L3.1</span></code> (from <code class="docutils literal notranslate"><span class="pre">FN2O</span></code>), <code class="docutils literal notranslate"><span class="pre">FCH4_L3.1</span></code> (from <code class="docutils literal notranslate"><span class="pre">FCH4</span></code>)</p></li>
<li><p>The suffix <code class="docutils literal notranslate"><span class="pre">_L3.1</span></code> is added to all fluxes to make it clear that the respective flux is storage corrected. Only for <code class="docutils literal notranslate"><span class="pre">NEE</span></code> it is clear that it is the storage-corrected flux because the name changes from <code class="docutils literal notranslate"><span class="pre">FC</span></code> to <code class="docutils literal notranslate"><span class="pre">NEE</span></code> after the correction, but all other variables do not have such a name change, thus the suffix.</p></li>
<li><p>Note that the overall quality flag from Level-2 is not used here</p></li>
<li><p>Example output from diive for NEE (in this step still called <code class="docutils literal notranslate"><span class="pre">FC</span></code>, after the storage correction this becomes <code class="docutils literal notranslate"><span class="pre">NEE_L3.1</span></code>):</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">========================================</span>
<span class="n">REPORT</span><span class="p">:</span> <span class="n">STORAGE</span> <span class="n">CORRECTION</span> <span class="n">FOR</span> <span class="n">FC</span>
<span class="o">========================================</span>
<span class="n">Swiss</span> <span class="n">FluxNet</span> <span class="n">processing</span> <span class="n">chain</span><span class="p">,</span> <span class="n">_L3</span><span class="mf">.1</span><span class="p">:</span> <span class="n">Storage</span> <span class="n">Correction</span>

<span class="n">The</span> <span class="n">gap</span><span class="o">-</span><span class="n">filled</span> <span class="n">storage</span> <span class="n">term</span> <span class="n">SC_SINGLE_gfRMED_L3</span><span class="mf">.1</span> <span class="n">was</span> <span class="n">added</span> <span class="n">to</span> <span class="n">flux</span> <span class="n">FC</span><span class="o">.</span>
<span class="n">The</span> <span class="n">storage</span><span class="o">-</span><span class="n">corrected</span> <span class="n">flux</span> <span class="n">was</span> <span class="n">stored</span> <span class="k">as</span> <span class="n">NEE_L3</span><span class="mf">.1</span><span class="o">.</span>

<span class="n">The</span> <span class="n">flux</span> <span class="n">was</span> <span class="n">available</span> <span class="k">for</span> <span class="mi">295350</span> <span class="n">records</span> <span class="p">(</span><span class="n">FC</span><span class="p">)</span><span class="o">.</span>
<span class="n">The</span> <span class="n">original</span><span class="p">,</span> <span class="n">non</span><span class="o">-</span><span class="n">gapfilled</span> <span class="n">storage</span> <span class="n">term</span> <span class="n">was</span> <span class="n">available</span> <span class="k">for</span> <span class="mi">290861</span> <span class="n">records</span> <span class="p">(</span><span class="n">SC_SINGLE</span><span class="p">)</span><span class="o">.</span>
<span class="n">The</span> <span class="n">original</span> <span class="n">storage</span> <span class="n">term</span> <span class="n">SC_SINGLE</span> <span class="n">was</span> <span class="n">missing</span> <span class="k">for</span> <span class="mi">7259</span> <span class="n">flux</span> <span class="n">records</span><span class="o">.</span>
<span class="n">Without</span> <span class="n">gap</span><span class="o">-</span><span class="n">filling</span> <span class="n">the</span> <span class="n">storage</span> <span class="n">term</span> <span class="p">(</span><span class="n">SC_SINGLE</span><span class="p">),</span> <span class="mi">7259</span> <span class="n">measured</span> <span class="n">flux</span> <span class="n">records</span> <span class="p">(</span><span class="n">FC</span><span class="p">)</span> <span class="n">are</span> <span class="n">lost</span><span class="o">.</span>

<span class="n">For</span> <span class="n">this</span> <span class="n">run</span><span class="p">,</span> <span class="n">gap</span><span class="o">-</span><span class="n">filling</span> <span class="n">of</span> <span class="n">SC_SINGLE</span> <span class="n">was</span> <span class="o">*</span> <span class="n">SELECTED</span> <span class="o">*.</span>
<span class="n">After</span> <span class="n">gap</span><span class="o">-</span><span class="n">filling</span> <span class="n">the</span> <span class="n">storage</span> <span class="n">term</span><span class="p">,</span> <span class="n">it</span> <span class="n">was</span> <span class="n">available</span> <span class="k">for</span> <span class="n">an</span> <span class="n">additional</span> <span class="mi">7259</span> <span class="n">records</span> <span class="p">(</span><span class="n">SC_SINGLE_gfRMED_L3</span><span class="mf">.1</span><span class="p">)</span><span class="o">.</span>

<span class="n">In</span> <span class="n">the</span> <span class="n">storage</span><span class="o">-</span><span class="n">corrected</span> <span class="n">flux</span> <span class="n">NEE_L3</span><span class="mf">.1</span> <span class="k">with</span> <span class="mi">295350</span> <span class="n">records</span><span class="p">,</span> 
  <span class="o">-</span> <span class="mf">97.5</span><span class="o">%</span> <span class="p">(</span><span class="mi">290861</span> <span class="n">records</span><span class="p">)</span> <span class="n">of</span> <span class="n">used</span> <span class="n">storage</span> <span class="n">terms</span> <span class="n">come</span> <span class="kn">from</span><span class="w"> </span><span class="nn">originally</span> <span class="n">calculated</span> <span class="n">data</span> <span class="p">(</span><span class="n">SC_SINGLE</span><span class="p">)</span>
  <span class="o">-</span> <span class="mf">2.5</span><span class="o">%</span> <span class="p">(</span><span class="mi">7259</span> <span class="n">records</span><span class="p">)</span> <span class="n">of</span> <span class="n">used</span> <span class="n">storage</span> <span class="n">terms</span> <span class="n">come</span> <span class="kn">from</span><span class="w"> </span><span class="nn">gap</span><span class="o">-</span><span class="n">filled</span> <span class="n">data</span> <span class="p">(</span><span class="n">SC_SINGLE_gfRMED_L3</span><span class="mf">.1</span><span class="p">)</span>

<span class="n">Stats</span> <span class="k">for</span> <span class="n">gap</span><span class="o">-</span><span class="n">filled</span> <span class="n">storage</span> <span class="n">terms</span><span class="p">:</span>
                        <span class="n">NOV</span>       <span class="n">P01</span>    <span class="n">MEDIAN</span>       <span class="n">P99</span>
<span class="n">SC_SINGLE_gfRMED_L3</span><span class="mf">.1</span>  <span class="mi">7259</span> <span class="o">-</span><span class="mf">8.395369</span> <span class="o">-</span><span class="mf">0.167553</span>  <span class="mf">6.810566</span>

<span class="n">Stats</span> <span class="k">for</span> <span class="n">measured</span> <span class="n">storage</span> <span class="n">terms</span><span class="p">:</span>
                          <span class="n">NOV</span>       <span class="n">P01</span>    <span class="n">MEDIAN</span>       <span class="n">P99</span>
<span class="n">SC_SINGLE_gfRMED_L3</span><span class="mf">.1</span>  <span class="mi">288091</span> <span class="o">-</span><span class="mf">7.555871</span> <span class="o">-</span><span class="mf">0.015403</span>  <span class="mf">6.739739</span>
</pre></div>
</div>
</section>
<section id="level-3-2-outlier-removal">
<h2>Level 3.2: Outlier removal<a class="headerlink" href="#level-3-2-outlier-removal" title="Link to this heading">#</a></h2>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span>
flowchart LR
	L2[Level-2 QCF]
	L31[Level-3.1 fluxes]
	L31f[filtered Level-3.1 fluxes]
	L32[Level-3.2 outlier flags]
	
	L2 -- apply flag to --&gt; L31 --&gt; L31f
	--&gt; L32
	
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Level-3.2 creates additional quality flags.</strong></p></li>
<li><p>The overall quality flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code> from Level-2 is applied to Level-3.1 fluxes to remove fluxes of low quality before outlier detection. This is a <em>temporary</em> application for outlier removal detection only. This way the outlier removal functions do not take into account values that were already flagged for removal in Level-2.</p></li>
</ul>
<p>Generally, the following outlier tests were used. The tests were run sequentially, so that results from one test were based on results from the previous test.</p>
<section id="description-of-outlier-functions">
<h3>Description of outlier functions<a class="headerlink" href="#description-of-outlier-functions" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Absolute limits</strong>: flag values outside a physically plausible range.</p></li>
<li><p><strong>Manual flag</strong>: flag specific time periods, e.g., due to known instrument failure</p></li>
<li><p><strong>Hampel filter</strong>, separate for daytime and nighttime. The Hampel filter identifies anomalies in time-series data using a sliding window of adjustable size. Within each window, it compares each data point to the Median Absolute Deviation (MAD). Points exceeding the MAD by a specified multiple (adjustable) are flagged as outliers.</p></li>
<li><p><strong>Local standard deviation</strong>, with rolling median and <em>constant</em> standard deviation (SD). SD was calculated across all data and then used in combination with the rolling window.</p></li>
<li><p><strong>Local outlier factor</strong>, separate for daytime and nighttime. Local Outlier Factor (LOF) is an unsupervised anomaly detection method. It calculates an anomaly score based on the local density deviation of a sample compared to its k-nearest neighbors. Samples with significantly lower density than their neighbors are identified as outliers. See also the official description <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.LocalOutlierFactor.html">here</a>.</p></li>
<li><p><strong>Rolling z-score</strong>, identify outliers based on the rolling z-score of records. For each record, the rolling z-score is calculated from the rolling mean and rolling standard deviation, centered on the respective value.</p></li>
</ul>
</section>
<section id="outlier-detection-settings">
<h3>Outlier detection settings<a class="headerlink" href="#outlier-detection-settings" title="Link to this heading">#</a></h3>
<p>Outlier methods are given for each flux in the order of sequential application.</p>
<section id="nee-net-ecosystem-exchange-of-co2">
<h4>NEE (net ecosystem exchange of CO<sub>2</sub>)<a class="headerlink" href="#nee-net-ecosystem-exchange-of-co2" title="Link to this heading">#</a></h4>
<p>Units: µmol CO<sub>2</sub> m<sup>-2</sup> s<sup>-1</sup></p>
<ol class="arabic simple">
<li><p><strong>Absolute limits</strong>: flag data outside <code class="docutils literal notranslate"><span class="pre">[-50,</span> <span class="pre">50]</span></code></p></li>
<li><p><strong>Manual flag</strong>: flag data between the two dates <code class="docutils literal notranslate"><span class="pre">['2008-12-01',</span> <span class="pre">'2009-05-01']</span></code></p></li>
<li><p><strong>Hampel filter</strong> separate for daytime and nighttime with the settings <code class="docutils literal notranslate"><span class="pre">window_length=48*13</span></code> (corresponds to 13 days of half-hourly data), <code class="docutils literal notranslate"><span class="pre">n_sigma_dt=3.5</span></code> and <code class="docutils literal notranslate"><span class="pre">n_sigma_nt=3.5</span></code> (same n_sigma for daytime and nighttime). This test worked well for NEE. Test repeated until all outliers removed.</p></li>
<li><p><strong>Local standard deviation</strong>, with rolling median and <em>constant</em> standard deviation with the settings <code class="docutils literal notranslate"><span class="pre">n_sd=3.5</span></code> and <code class="docutils literal notranslate"><span class="pre">winsize=48*13</span></code>. Test repeated until all outliers removed.</p></li>
</ol>
</section>
<section id="le-latent-heat">
<h4>LE (latent heat)<a class="headerlink" href="#le-latent-heat" title="Link to this heading">#</a></h4>
<p>Units: W m<sup>-2</sup></p>
<ol class="arabic simple">
<li><p><strong>Absolute limits</strong>: flag data outside <code class="docutils literal notranslate"><span class="pre">[-50,</span> <span class="pre">800]</span></code></p></li>
<li><p><strong>Manual flag</strong>: flag data between the two dates <code class="docutils literal notranslate"><span class="pre">['2008-12-01',</span> <span class="pre">'2009-05-01']</span></code></p></li>
<li><p><strong>Hampel filter</strong> separate for daytime and nighttime with the settings <code class="docutils literal notranslate"><span class="pre">window_length=48*13</span></code> (corresponds to 13 days of half-hourly data), <code class="docutils literal notranslate"><span class="pre">n_sigma_dt=3.5</span></code> and <code class="docutils literal notranslate"><span class="pre">n_sigma_nt=3.5</span></code> (same n_sigma for daytime and nighttime). Test repeated until all outliers removed.</p></li>
<li><p><strong>Local standard deviation</strong>, with rolling median and <em>constant</em> standard deviation with the settings <code class="docutils literal notranslate"><span class="pre">n_sd=4.5</span></code> and <code class="docutils literal notranslate"><span class="pre">winsize=48*13</span></code>. Test repeated until all outliers removed.</p></li>
<li><p><strong>Local outlier factor</strong>, separate for daytime and nighttime with the settings <code class="docutils literal notranslate"><span class="pre">n_neighbors=50</span></code> and <code class="docutils literal notranslate"><span class="pre">contamination=None</span></code>. Test not repeated, only run once.</p></li>
</ol>
</section>
<section id="h-sensible-heat">
<h4>H (sensible heat)<a class="headerlink" href="#h-sensible-heat" title="Link to this heading">#</a></h4>
<p>Units: W m<sup>-2</sup></p>
<ol class="arabic simple">
<li><p><strong>Absolute limits</strong>: flag data outside <code class="docutils literal notranslate"><span class="pre">[-200,</span> <span class="pre">400]</span></code></p></li>
<li><p><strong>Manual flag</strong>: flag data between the two dates <code class="docutils literal notranslate"><span class="pre">['2008-12-01',</span> <span class="pre">'2009-05-01']</span></code></p></li>
<li><p><strong>Hampel filter</strong> separate for daytime and nighttime with the settings <code class="docutils literal notranslate"><span class="pre">window_length=48*13</span></code> (corresponds to 13 days of half-hourly data), <code class="docutils literal notranslate"><span class="pre">n_sigma_dt=3.5</span></code> and <code class="docutils literal notranslate"><span class="pre">n_sigma_nt=3.5</span></code> (same n_sigma for daytime and nighttime). Test repeated until all outliers removed.</p></li>
<li><p><strong>Local standard deviation</strong>, with rolling median and <em>constant</em> standard deviation with the settings <code class="docutils literal notranslate"><span class="pre">n_sd=5</span></code> and <code class="docutils literal notranslate"><span class="pre">winsize=48*13</span></code>. Test repeated until all outliers removed.</p></li>
</ol>
</section>
<section id="fn2o-nitrous-oxide-flux">
<h4>FN2O (nitrous oxide flux)<a class="headerlink" href="#fn2o-nitrous-oxide-flux" title="Link to this heading">#</a></h4>
<p>Units: nmol N<sub>2</sub>O m<sup>-2</sup> s<sup>-1</sup></p>
<ol class="arabic simple">
<li><p><strong>Absolute limits</strong>: flag data outside <code class="docutils literal notranslate"><span class="pre">[-5,</span> <span class="pre">70]</span></code></p></li>
<li><p><strong>Rolling z-score</strong>, with the settings <code class="docutils literal notranslate"><span class="pre">winsize=48*3</span></code> and <code class="docutils literal notranslate"><span class="pre">thres_zscore=10</span></code>. Test repeated until all outliers removed.</p></li>
<li><p><strong>Local standard deviation</strong>, with rolling median and <em>rolling</em> standard deviation with the settings <code class="docutils literal notranslate"><span class="pre">n_sd=8</span></code> and <code class="docutils literal notranslate"><span class="pre">winsize=48*3</span></code>. Test repeated until all outliers removed.</p></li>
</ol>
</section>
<section id="fch4-methane-flux">
<h4>FCH4 (methane flux)<a class="headerlink" href="#fch4-methane-flux" title="Link to this heading">#</a></h4>
<p>Units: nmol CH<sub>4</sub> m<sup>-2</sup> s<sup>-1</sup></p>
<ol class="arabic simple">
<li><p><strong>Absolute limits</strong>: flag data outside <code class="docutils literal notranslate"><span class="pre">[-100,</span> <span class="pre">1100]</span></code></p></li>
<li><p><strong>Rolling z-score</strong>, with the settings <code class="docutils literal notranslate"><span class="pre">winsize=48*3</span></code> and <code class="docutils literal notranslate"><span class="pre">thres_zscore=8</span></code>. Test repeated until all outliers removed.</p></li>
<li><p><strong>Local standard deviation</strong>, with rolling median and <em>rolling</em> standard deviation with the settings <code class="docutils literal notranslate"><span class="pre">n_sd=7</span></code> and <code class="docutils literal notranslate"><span class="pre">winsize=48*3</span></code>. Test repeated until all outliers removed.</p></li>
</ol>
</section>
</section>
</section>
<section id="level-3-3-ustar-filtering">
<h2>Level 3.3: USTAR filtering<a class="headerlink" href="#level-3-3-ustar-filtering" title="Link to this heading">#</a></h2>
<ul>
<li><p>Remove fluxes during time periods of low turbulence</p></li>
<li><p>Fluxes filtered with USTAR threshold: <code class="docutils literal notranslate"><span class="pre">NEE</span></code>, <code class="docutils literal notranslate"><span class="pre">FN2O</span></code>, <code class="docutils literal notranslate"><span class="pre">FCH4</span></code></p></li>
<li><p>Fluxes <em>not</em> filtered: <code class="docutils literal notranslate"><span class="pre">LE</span></code>, <code class="docutils literal notranslate"><span class="pre">H</span></code>; see reasoning in Pastorello et al. (2020):</p>
<blockquote>
<div><p>The USTAR filtering is not applied to H and LE, because it has not been proved that when there are CO2 advective fluxes, these also impact energy fluxes, specifically due to the fact that when advection is in general large (nighttime), energy fluxes are small.</p>
</div></blockquote>
</li>
<li><p>A constant USTAR threshold (<code class="docutils literal notranslate"><span class="pre">CUT</span></code>) was used for all years (same threshold for all years)</p></li>
<li><p>Threshold values are based on USTAR detection results from the most recent FLUXNET data product (2024)</p></li>
<li><p>The threshold detection was done by FLUXNET, using data between 2005 and 2023 and using the method described in Pastorello et al. (2020)</p></li>
<li><p>Following Pastorello et al. (2020), three USTAR scenarios were considered to calculate three NEE versions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CUT_50</span></code>: This is the main NEE version (best estimate) with a constant USTAR threshold of <code class="docutils literal notranslate"><span class="pre">0.069898</span></code>, corresponding to the 50th percentile from the FLUXNET detection results</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CUT_16</span></code>: NEE version with a constant USTAR threshold of <code class="docutils literal notranslate"><span class="pre">0.052945</span></code>, corresponding to the 16th percentile from the FLUXNET detection results</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CUT_84</span></code>: NEE version with a constant USTAR threshold of <code class="docutils literal notranslate"><span class="pre">0.092841</span></code>, corresponding to the 84th percentile from the FLUXNET detection results</p></li>
<li><p>The two other scenarios use a slightly lower and higher threshold.</p></li>
</ul>
</li>
</ul>
</section>
<section id="qcf-overall-quality-control-flag-after-level-3-3-tests">
<h2>QCF: overall quality control flag after Level-3.3 tests<a class="headerlink" href="#qcf-overall-quality-control-flag-after-level-3-3-tests" title="Link to this heading">#</a></h2>
<p><em>See below for a description of how <code class="docutils literal notranslate"><span class="pre">QCF</span></code> is calculated.</em></p>
<ul class="simple">
<li><p><strong>For subsequent steps, fully quality-filtered fluxes are needed.</strong></p></li>
<li><p>Therefore, after running the individual quality tests in previous steps, the single flags are combined into the overall <code class="docutils literal notranslate"><span class="pre">QCF</span></code>.</p></li>
<li><p>This creates flux variables that have been filtered by all quality flags created in Level-2, Level-3.2 and Level-3.3.</p></li>
<li><p>The overall quality flag after Level-3.3 is named <code class="docutils literal notranslate"><span class="pre">FLAG_L3.3_&lt;ustar_scenario&gt;_&lt;flux&gt;_QCF</span></code>.</p></li>
<li><p><strong>Example</strong> for NEE:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">FLAG_L3.3_CUT_50_NEE_L3.1_QCF</span></code> is the <code class="docutils literal notranslate"><span class="pre">QCF</span></code> for <code class="docutils literal notranslate"><span class="pre">NEE_L3.1</span></code> after Level-3.3.</p></li>
<li><p>This flag is used to filter the variable <code class="docutils literal notranslate"><span class="pre">NEE_L3.1</span></code> and creates the quality-filtered variable <code class="docutils literal notranslate"><span class="pre">NEE_L3.1_L3.3_CUT_50_QCF</span></code>, that is then used in the following steps.</p></li>
<li><p>Note that <code class="docutils literal notranslate"><span class="pre">NEE_L3.1</span></code> is the unfiltered, but storage-corrected variable <code class="docutils literal notranslate"><span class="pre">FC</span></code> from the flux calculations.</p></li>
</ul>
</li>
<li><p><strong>Examples</strong> for <code class="docutils literal notranslate"><span class="pre">&lt;ustar_scenario&gt;</span></code>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">CUT_16</span></code>, <code class="docutils literal notranslate"><span class="pre">CUT_50</span></code>, <code class="docutils literal notranslate"><span class="pre">CUT_84</span></code></p></li>
</ul>
</li>
<li><p><strong>Examples</strong> for <code class="docutils literal notranslate"><span class="pre">&lt;flux&gt;</span></code>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">FC_L3.1</span></code>, <code class="docutils literal notranslate"><span class="pre">LE_L3.1</span></code>, <code class="docutils literal notranslate"><span class="pre">H_L3.1</span></code>, <code class="docutils literal notranslate"><span class="pre">FN2O_L3.1</span></code>, <code class="docutils literal notranslate"><span class="pre">FCH4_L3.1</span></code></p></li>
<li><p>These are fluxes that are storage-corrected (Level-3.1), but are not filtered yet.</p></li>
</ul>
</li>
<li><p><strong>Example</strong> output from diive for <code class="docutils literal notranslate"><span class="pre">NEE_L3.1</span></code> (storage-corrected <code class="docutils literal notranslate"><span class="pre">FC</span></code> from Level-3.1) for the USTAR scenario <code class="docutils literal notranslate"><span class="pre">CUT_50</span></code>, detailing the sequential application of all individual quality flags from Level-2, Level-3.2 and Level-3.3:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">========================================</span>
<span class="n">QCF</span> <span class="n">FLAG</span> <span class="n">EVOLUTION</span>
<span class="o">========================================</span>
<span class="n">This</span> <span class="n">output</span> <span class="n">shows</span> <span class="n">the</span> <span class="n">evolution</span> <span class="n">of</span> <span class="n">the</span> <span class="n">QCF</span> <span class="n">overall</span> <span class="n">quality</span> <span class="n">flag</span>
<span class="n">when</span> <span class="n">test</span> <span class="n">flags</span> <span class="n">are</span> <span class="n">applied</span> <span class="n">sequentially</span> <span class="n">to</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">NEE_L3</span><span class="mf">.1</span><span class="o">.</span>

<span class="n">Number</span> <span class="n">of</span> <span class="n">NEE_L3</span><span class="mf">.1</span> <span class="n">records</span> <span class="n">before</span> <span class="n">QC</span><span class="p">:</span> <span class="mi">295350</span>
<span class="o">+++</span> <span class="n">FLAG_L2_FC_MISSING_TEST</span> <span class="n">rejected</span> <span class="mi">0</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.00</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">295350</span> <span class="p">(</span><span class="mf">100.00</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">0</span> <span class="p">(</span><span class="mf">0.00</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">0</span> <span class="p">(</span><span class="mf">0.00</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L2_FC_SSITC_TEST</span> <span class="n">rejected</span> <span class="mi">133899</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">45.34</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">115080</span> <span class="p">(</span><span class="mf">38.96</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">46371</span> <span class="p">(</span><span class="mf">15.70</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">133899</span> <span class="p">(</span><span class="mf">45.34</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L2_FC_COMPLETENESS_TEST</span> <span class="n">rejected</span> <span class="mi">690</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.23</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">114423</span> <span class="p">(</span><span class="mf">38.74</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">46338</span> <span class="p">(</span><span class="mf">15.69</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">134589</span> <span class="p">(</span><span class="mf">45.57</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L2_FC_SCF_TEST</span> <span class="n">rejected</span> <span class="mi">194</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.07</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">114201</span> <span class="p">(</span><span class="mf">38.67</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">46366</span> <span class="p">(</span><span class="mf">15.70</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">134783</span> <span class="p">(</span><span class="mf">45.64</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L2_FC_SIGNAL_STRENGTH_TEST</span> <span class="n">rejected</span> <span class="mi">9808</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">3.32</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">110029</span> <span class="p">(</span><span class="mf">37.25</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">40730</span> <span class="p">(</span><span class="mf">13.79</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">144591</span> <span class="p">(</span><span class="mf">48.96</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST</span> <span class="n">rejected</span> <span class="mi">942</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.32</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">109335</span> <span class="p">(</span><span class="mf">37.02</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">40482</span> <span class="p">(</span><span class="mf">13.71</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">145533</span> <span class="p">(</span><span class="mf">49.27</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L2_FC_CO2_VM97_AMPLITUDE_RESOLUTION_HF_TEST</span> <span class="n">rejected</span> <span class="mi">3826</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">1.30</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">106807</span> <span class="p">(</span><span class="mf">36.16</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">39184</span> <span class="p">(</span><span class="mf">13.27</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">149359</span> <span class="p">(</span><span class="mf">50.57</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L2_FC_CO2_VM97_DROPOUT_TEST</span> <span class="n">rejected</span> <span class="mi">0</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.00</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">106807</span> <span class="p">(</span><span class="mf">36.16</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">39184</span> <span class="p">(</span><span class="mf">13.27</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">149359</span> <span class="p">(</span><span class="mf">50.57</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L2_FC_VM97_AOA_HF_TEST</span> <span class="n">rejected</span> <span class="mi">2607</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.88</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">105860</span> <span class="p">(</span><span class="mf">35.84</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">37524</span> <span class="p">(</span><span class="mf">12.70</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">151966</span> <span class="p">(</span><span class="mf">51.45</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L3</span><span class="mf">.2</span><span class="n">_NEE_L3</span><span class="mf">.1</span><span class="n">_QCF_OUTLIER_ABSLIM_TEST</span> <span class="n">rejected</span> <span class="mi">2038</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.69</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">105590</span> <span class="p">(</span><span class="mf">35.75</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">35756</span> <span class="p">(</span><span class="mf">12.11</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">154004</span> <span class="p">(</span><span class="mf">52.14</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L3</span><span class="mf">.2</span><span class="n">_NEE_L3</span><span class="mf">.1</span><span class="n">_QCF_OUTLIER_MANUAL_TEST</span> <span class="n">rejected</span> <span class="mi">731</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.25</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">105303</span> <span class="p">(</span><span class="mf">35.65</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">35312</span> <span class="p">(</span><span class="mf">11.96</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">154735</span> <span class="p">(</span><span class="mf">52.39</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L3</span><span class="mf">.2</span><span class="n">_NEE_L3</span><span class="mf">.1</span><span class="n">_QCF_OUTLIER_HAMPELDTNT_TEST</span> <span class="n">rejected</span> <span class="mi">4302</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">1.46</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">103478</span> <span class="p">(</span><span class="mf">35.04</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">32835</span> <span class="p">(</span><span class="mf">11.12</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">159037</span> <span class="p">(</span><span class="mf">53.85</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L3</span><span class="mf">.2</span><span class="n">_NEE_L3</span><span class="mf">.1</span><span class="n">_QCF_OUTLIER_LOCALSD_TEST</span> <span class="n">rejected</span> <span class="mi">282</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.10</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">103432</span> <span class="p">(</span><span class="mf">35.02</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">32599</span> <span class="p">(</span><span class="mf">11.04</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">159319</span> <span class="p">(</span><span class="mf">53.94</span><span class="o">%</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">FLAG_L3</span><span class="mf">.3</span><span class="n">_CUT_50_NEE_L3</span><span class="mf">.1</span><span class="n">_USTAR_TEST</span> <span class="n">rejected</span> <span class="mi">16564</span> <span class="n">values</span> <span class="p">(</span><span class="o">+</span><span class="mf">5.61</span><span class="o">%</span><span class="p">)</span>      <span class="n">TOTALS</span><span class="p">:</span> <span class="n">flag</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">92913</span> <span class="p">(</span><span class="mf">31.46</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">26554</span> <span class="p">(</span><span class="mf">8.99</span><span class="o">%</span><span class="p">)</span> <span class="o">/</span> <span class="n">flag</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">175883</span> <span class="p">(</span><span class="mf">59.55</span><span class="o">%</span><span class="p">)</span>

<span class="n">In</span> <span class="n">total</span><span class="p">,</span> <span class="mi">175883</span> <span class="p">(</span><span class="mf">59.55</span><span class="o">%</span><span class="p">)</span> <span class="n">of</span> <span class="n">the</span> <span class="n">available</span> <span class="n">records</span> <span class="n">were</span> <span class="n">rejected</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">step</span><span class="o">.</span>
<span class="n">INFO</span> <span class="n">Rejected</span> <span class="n">DAYTIME</span> <span class="n">records</span> <span class="n">where</span> <span class="n">QCF</span> <span class="n">flag</span> <span class="o">&gt;=</span> <span class="mi">2</span>
<span class="n">INFO</span> <span class="n">Rejected</span> <span class="n">NIGHTTIME</span> <span class="n">records</span> <span class="n">where</span> <span class="n">QCF</span> <span class="n">flag</span> <span class="o">&gt;=</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">========================================</span>
<span class="n">SUMMARY</span><span class="p">:</span> <span class="n">FLAG_L3</span><span class="mf">.3</span><span class="n">_CUT_50_NEE_L3</span><span class="mf">.1</span><span class="n">_QCF</span><span class="p">,</span> <span class="n">QCF</span> <span class="n">FLAG</span> <span class="n">FOR</span> <span class="n">NEE_L3</span><span class="mf">.1</span>
<span class="o">========================================</span>
<span class="n">Between</span> <span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">15</span> <span class="ow">and</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">23</span><span class="p">:</span><span class="mi">45</span> <span class="o">...</span>
    <span class="n">Total</span> <span class="n">flux</span> <span class="n">records</span> <span class="n">BEFORE</span> <span class="n">quality</span> <span class="n">checks</span><span class="p">:</span> <span class="mi">295350</span> <span class="p">(</span><span class="mf">84.23</span><span class="o">%</span> <span class="n">of</span> <span class="n">potential</span><span class="p">)</span>
    <span class="n">Available</span> <span class="n">flux</span> <span class="n">records</span> <span class="n">AFTER</span> <span class="n">quality</span> <span class="n">checks</span><span class="p">:</span> <span class="mi">119467</span> <span class="p">(</span><span class="mf">40.45</span><span class="o">%</span> <span class="n">of</span> <span class="n">total</span><span class="p">)</span>
    <span class="n">Rejected</span> <span class="n">flux</span> <span class="n">records</span><span class="p">:</span> <span class="mi">175883</span> <span class="p">(</span><span class="mf">59.55</span><span class="o">%</span> <span class="n">of</span> <span class="n">total</span><span class="p">)</span>
    <span class="n">Potential</span> <span class="n">flux</span> <span class="n">records</span><span class="p">:</span> <span class="mi">350640</span>
    <span class="n">Potential</span> <span class="n">flux</span> <span class="n">records</span> <span class="n">missed</span><span class="p">:</span> <span class="mi">55290</span> <span class="p">(</span><span class="mf">15.77</span><span class="o">%</span> <span class="n">of</span> <span class="n">potential</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="level-4-1-gap-filling">
<h2>Level 4.1: Gap-filling<a class="headerlink" href="#level-4-1-gap-filling" title="Link to this heading">#</a></h2>
<section id="random-forest">
<h3>Random forest<a class="headerlink" href="#random-forest" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>All fluxes were gap-filled using the class <code class="docutils literal notranslate"><span class="pre">LongTermGapFillingRandomForestTS</span></code> from <a class="reference external" href="https://github.com/holukas/diive/tree/main">diive</a></p></li>
<li><p>This class builds a random forest model for each year, trained on data of the respective year and the two closest/neighboring years</p></li>
<li><p>For example: for gap-filling 2015, the model was trained on 2014, 2015 and 2016. For 2005 (the very first year for FC fluxes), the two closest years were used, i.e., the model was trained on 2005, 2006 and 2007. Likewise, for the very last year, the model was trained on data from the last year and the two preceding years.</p></li>
<li><p>Generally used random forest settings: <code class="docutils literal notranslate"><span class="pre">n_estimators</span></code>: 500, <code class="docutils literal notranslate"><span class="pre">random_state</span></code>: 42, <code class="docutils literal notranslate"><span class="pre">min_samples_split</span></code>: 2, <code class="docutils literal notranslate"><span class="pre">min_samples_leaf</span></code>: 1, default settings were used for all other parameters, see <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html">here</a>.</p></li>
</ul>
<section id="features-predictors">
<h4>Features (predictors)<a class="headerlink" href="#features-predictors" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Variables used as features in training the random forest models.</p></li>
<li><p>In addition to features listed below, timestamp info was included as additional features:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">++</span> <span class="n">Added</span> <span class="n">new</span> <span class="n">columns</span> <span class="k">with</span> <span class="n">timestamp</span> <span class="n">info</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;.YEAR&#39;</span><span class="p">,</span> <span class="s1">&#39;.SEASON&#39;</span><span class="p">,</span> <span class="s1">&#39;.MONTH&#39;</span><span class="p">,</span> <span class="s1">&#39;.WEEK&#39;</span><span class="p">,</span> <span class="s1">&#39;.DOY&#39;</span><span class="p">,</span> <span class="s1">&#39;.HOUR&#39;</span><span class="p">,</span> <span class="s1">&#39;.YEARMONTH&#39;</span><span class="p">,</span> <span class="s1">&#39;.YEARDOY&#39;</span><span class="p">,</span> <span class="s1">&#39;.YEARWEEK&#39;</span><span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Lagged variants</strong> were calculated for <code class="docutils literal notranslate"><span class="pre">SW_IN_T1_2_1</span></code>, <code class="docutils literal notranslate"><span class="pre">TA_T1_2_1</span></code>, <code class="docutils literal notranslate"><span class="pre">VPD_T1_2_1</span></code> and all variables listed in  <code class="docutils literal notranslate"><span class="pre">METEO_VARS</span></code> (see below).</p></li>
<li><p>Feature importances were calculated as <strong>permutation importance</strong>: Permutation feature importance assesses feature contributions to a model’s performance. It works by randomly shuffling a feature’s values, observing the resulting performance drop. This reveals how much the model relies on that feature.</p></li>
<li><p><strong>Feature reduction</strong>: Feature reduction was performed by comparing feature importances to a random variable (<code class="docutils literal notranslate"><span class="pre">.RANDOM</span></code>), which consisted of random numbers (floats) between 0 and 1. Features with importance below <code class="docutils literal notranslate"><span class="pre">.RANDOM</span></code>’s were discarded. To ensure consistency across yearly models, a feature was only removed if it was deemed unimportant in <em>all</em> yearly models. A feature was retained if it was deemed important in at least one model.</p></li>
</ul>
<section id="nee-le-h">
<h5>NEE, LE, H<a class="headerlink" href="#nee-le-h" title="Link to this heading">#</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MGMT_VARS</span> <span class="o">=</span> <span class="p">[</span>
<span class="s2">&quot;TIMESINCE_MGMT_FERT_MIN_FOOTPRINT&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESINCE_MGMT_FERT_ORG_FOOTPRINT&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESINCE_MGMT_GRAZING_FOOTPRINT&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESINCE_MGMT_MOWING_FOOTPRINT&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESINCE_MGMT_SOILCULTIVATION_FOOTPRINT&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESINCE_MGMT_SOWING_FOOTPRINT&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESINCE_MGMT_PESTICIDE_HERBICIDE_FOOTPRINT&quot;</span><span class="p">]</span>

<span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span>
<span class="s2">&quot;SW_IN_T1_2_1&quot;</span><span class="p">,</span> <span class="s2">&quot;TA_T1_2_1&quot;</span><span class="p">,</span> <span class="s2">&quot;VPD_T1_2_1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MGMT_VARS</span>
</pre></div>
</div>
</section>
<section id="fn2o-fch4">
<h5>FN2O, FCH4<a class="headerlink" href="#fn2o-fch4" title="Link to this heading">#</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Management variables (also includes time since PRECIP)</span>
<span class="n">MGMT_VARS</span> <span class="o">=</span> <span class="p">[</span>
<span class="s2">&quot;TIMESINCE_MGMT_FERT_MIN_FOOTPRINT&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESINCE_MGMT_FERT_ORG_FOOTPRINT&quot;</span><span class="p">,</span>   <span class="s2">&quot;TIMESINCE_MGMT_GRAZING_FOOTPRINT&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESINCE_MGMT_MOWING_FOOTPRINT&quot;</span><span class="p">,</span>
<span class="s2">&quot;TIMESINCE_MGMT_SOILCULTIVATION_FOOTPRINT&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESINCE_MGMT_SOWING_FOOTPRINT&quot;</span><span class="p">,</span>
<span class="s2">&quot;TIMESINCE_MGMT_PESTICIDE_HERBICIDE_FOOTPRINT&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESINCE_PREC_RAIN_TOT_GF1_0.5_1&quot;</span>
<span class="p">]</span>

<span class="c1"># Already lagged variants of SWC, TS and PRECIP</span>
<span class="n">AGG_VARS</span> <span class="o">=</span> <span class="p">[</span>

<span class="c1"># SWC</span>
<span class="s2">&quot;SWC_GF1_0.15_1_gfXG_MEAN3H&quot;</span><span class="p">,</span> <span class="s2">&quot;.SWC_GF1_0.15_1_gfXG_MEAN3H-24&quot;</span><span class="p">,</span> <span class="s2">&quot;.SWC_GF1_0.15_1_gfXG_MEAN3H-18&quot;</span><span class="p">,</span> <span class="s2">&quot;.SWC_GF1_0.15_1_gfXG_MEAN3H-12&quot;</span><span class="p">,</span> <span class="s2">&quot;.SWC_GF1_0.15_1_gfXG_MEAN3H-6&quot;</span><span class="p">,</span>

<span class="c1"># TS</span>
<span class="s2">&quot;TS_GF1_0.04_1_gfXG_MEAN3H&quot;</span><span class="p">,</span> <span class="s2">&quot;.TS_GF1_0.04_1_gfXG_MEAN3H-24&quot;</span><span class="p">,</span> <span class="s2">&quot;.TS_GF1_0.04_1_gfXG_MEAN3H-18&quot;</span><span class="p">,</span> <span class="s2">&quot;.TS_GF1_0.04_1_gfXG_MEAN3H-12&quot;</span><span class="p">,</span> <span class="s2">&quot;.TS_GF1_0.04_1_gfXG_MEAN3H-6&quot;</span><span class="p">,</span> <span class="s2">&quot;TS_GF1_0.15_1_gfXG_MEAN3H&quot;</span><span class="p">,</span>   <span class="s2">&quot;.TS_GF1_0.15_1_gfXG_MEAN3H-24&quot;</span><span class="p">,</span> <span class="s2">&quot;.TS_GF1_0.15_1_gfXG_MEAN3H-18&quot;</span><span class="p">,</span>   <span class="s2">&quot;.TS_GF1_0.15_1_gfXG_MEAN3H-12&quot;</span><span class="p">,</span> <span class="s2">&quot;.TS_GF1_0.15_1_gfXG_MEAN3H-6&quot;</span><span class="p">,</span>
<span class="s2">&quot;TS_GF1_0.4_1_gfXG_MEAN3H&quot;</span><span class="p">,</span> <span class="s2">&quot;.TS_GF1_0.4_1_gfXG_MEAN3H-24&quot;</span><span class="p">,</span> <span class="s2">&quot;.TS_GF1_0.4_1_gfXG_MEAN3H-18&quot;</span><span class="p">,</span> <span class="s2">&quot;.TS_GF1_0.4_1_gfXG_MEAN3H-12&quot;</span><span class="p">,</span> <span class="s2">&quot;.TS_GF1_0.4_1_gfXG_MEAN3H-6&quot;</span><span class="p">,</span>

<span class="c1"># PRECIP</span>
<span class="s2">&quot;PREC_RAIN_TOT_GF1_0.5_1_MEAN3H&quot;</span><span class="p">,</span> <span class="s2">&quot;.PREC_RAIN_TOT_GF1_0.5_1_MEAN3H-24&quot;</span><span class="p">,</span> <span class="s2">&quot;.PREC_RAIN_TOT_GF1_0.5_1_MEAN3H-18&quot;</span><span class="p">,</span> <span class="s2">&quot;.PREC_RAIN_TOT_GF1_0.5_1_MEAN3H-12&quot;</span><span class="p">,</span> <span class="s2">&quot;.PREC_RAIN_TOT_GF1_0.5_1_MEAN3H-6&quot;</span>
<span class="p">]</span>

<span class="n">METEO_VARS</span> <span class="o">=</span> <span class="p">[</span>
<span class="s2">&quot;TS_GF1_0.04_1_gfXG&quot;</span><span class="p">,</span> <span class="s2">&quot;TS_GF1_0.15_1_gfXG&quot;</span><span class="p">,</span> <span class="s2">&quot;TS_GF1_0.4_1_gfXG&quot;</span><span class="p">,</span> <span class="s2">&quot;SWC_GF1_0.15_1_gfXG&quot;</span><span class="p">,</span> <span class="s2">&quot;PREC_RAIN_TOT_GF1_0.5_1&quot;</span>
<span class="p">]</span>

<span class="n">FEATURES</span> <span class="o">=</span> <span class="n">METEO_VARS</span> <span class="o">+</span> <span class="n">AGG_VARS</span> <span class="o">+</span> <span class="n">MGMT_VARS</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>
<section id="level-4-2-nee-partitioning-planned">
<h2>Level 4.2: NEE Partitioning (planned)<a class="headerlink" href="#level-4-2-nee-partitioning-planned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><em>planned</em></p></li>
<li><p>Nighttime method based on Reichstein et al (2005)</p></li>
<li><p>Daytime method based on Lasslop et al. (2010)</p></li>
<li><p>Modified daytime method based on Keenan et al. (2019)</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="qcf-overall-quality-control-flag">
<h2>QCF: overall quality control flag<a class="headerlink" href="#qcf-overall-quality-control-flag" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">QCF</span></code> (<strong>Q</strong>uality <strong>C</strong>ontrol <strong>F</strong>lag) is calculated from multiple flags from single tests.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QCF</span></code> is a flag that shows the <em>overall</em> quality of the respective data point.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QCF</span></code> can be: <code class="docutils literal notranslate"><span class="pre">0</span></code>=best data, <code class="docutils literal notranslate"><span class="pre">1</span></code>=OK data, <code class="docutils literal notranslate"><span class="pre">2</span></code>=bad data</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">QCF</span></code> is calculated from single test flags summed together</strong>:</p>
<ul>
<li><p>For records where the sum &gt; 2:  <code class="docutils literal notranslate"><span class="pre">QCF</span></code>=2</p></li>
<li><p>For records where the sum = 2 from a single flag with value 2: <code class="docutils literal notranslate"><span class="pre">QCF</span></code>=2</p></li>
<li><p>For records where the sum = 2 and no single flag is 2 (i.e., the sum comes from two single flags with value 1):  <code class="docutils literal notranslate"><span class="pre">QCF</span></code>=1</p></li>
<li><p>For records where the sum = 1 (i.e., only on single flag with value 1): <code class="docutils literal notranslate"><span class="pre">QCF</span></code>=1</p></li>
<li><p>For records where the sum = 0 (i.e., all single flags are zero): <code class="docutils literal notranslate"><span class="pre">QCF</span></code>=0 (best quality fluxes)</p></li>
</ul>
</li>
<li><p>Flags for single tests are created in Level-2, Level-3.2 and Level-3.3.</p></li>
<li><p>Genereally, single tests can be:</p>
<ul>
<li><p><strong>Hard flags</strong>: Some tests yield either 0 or 2, but have no flag=1. This is the case if the test is so crucial that if the test fails, data are considered bad. If one test flag=2, then the <code class="docutils literal notranslate"><span class="pre">QCF</span></code> is automatically 2, no matter the other tests. Flags from such tests are also called hard flags.</p></li>
<li><p><strong>Soft flags</strong>: If a test results is flag=1, it can still be OK data for some analyses. Even if there is a second test with flag=1, data might still be OK. If one or two flags are 1, and there is no flag=2, then the <code class="docutils literal notranslate"><span class="pre">QCF</span></code> is also 1. These flags are less crucial and are therefore soft flags.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">QCF</span></code> always uses the same logic, for both flux and meteo data, only the single tests are different.</p></li>
<li><p><strong>This was done for all fluxes, however, for NEE the requirements were stricter during the nighttime than during the daytime.</strong> For NEE, daytime <code class="docutils literal notranslate"><span class="pre">QCF</span></code> flags of 0 and 1 were accepted (flag 2 = bad data), but during nighttime only <code class="docutils literal notranslate"><span class="pre">QCF</span></code> flags with 0 were retained (flags 1 and 2 = bad data). For all other fluxes, <code class="docutils literal notranslate"><span class="pre">QCF</span></code> flags of 0 and 1 were accepted during daytime and nighttime (flag 2 = bad data).</p></li>
<li><p><strong>Example</strong>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">FLAG_L3.3_CUT_50_NEE_L3.1_QCF</span></code> is the flag after Level-3.3, for flux <code class="docutils literal notranslate"><span class="pre">NEE_L3.1</span></code> (storage-corrected) for the USTAR scenario <code class="docutils literal notranslate"><span class="pre">CUT_50</span></code>. This flag is applied to flux <code class="docutils literal notranslate"><span class="pre">NEE_L3.1</span></code>, producing the quality-filtered flux <code class="docutils literal notranslate"><span class="pre">NEE_L3.1_L3.3_CUT_50_QCF</span></code>. In addition, another flux variable is produced, containing only highest-quality fluxes: <code class="docutils literal notranslate"><span class="pre">NEE_L3.1_L3.3_CUT_50_QCF0</span></code> (all single flags are zero).</p></li>
</ul>
</li>
</ul>
<p><strong>Figure 1</strong>: Example showing how the overall quality control flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code> is calculated from single test flags.
<img alt="" src="../images/QCF_overall_quality_flag.png" /></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flux-processing-chain-notebooks">Flux processing chain notebooks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-2-quality-flag-expansion">Level 2: Quality flag expansion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general">General</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#individual-flags">Individual flags</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ssitc-test-flag"><strong>SSITC</strong> test flag</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gas-completeness-test-flag"><strong>Gas completeness</strong> test flag</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spectral-correction-factor-test-flag"><strong>Spectral correction factor</strong> test flag</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#signal-strength-test-flag"><strong>Signal strength</strong> test flag</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-data-screening-test-flags-multiple"><strong>Raw data screening</strong> test flags (multiple)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#angle-of-attack-aoa-flag"><strong>Angle-of-attack (AoA) flag</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#qcf-overall-quality-control-flag-after-level-2-tests">QCF: overall quality control flag after Level-2 tests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-1-storage-correction">Level 3.1: Storage correction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-2-outlier-removal">Level 3.2: Outlier removal</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#description-of-outlier-functions">Description of outlier functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-detection-settings">Outlier detection settings</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#nee-net-ecosystem-exchange-of-co2">NEE (net ecosystem exchange of CO<sub>2</sub>)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#le-latent-heat">LE (latent heat)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#h-sensible-heat">H (sensible heat)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fn2o-nitrous-oxide-flux">FN2O (nitrous oxide flux)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fch4-methane-flux">FCH4 (methane flux)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-3-ustar-filtering">Level 3.3: USTAR filtering</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#qcf-overall-quality-control-flag-after-level-3-3-tests">QCF: overall quality control flag after Level-3.3 tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-4-1-gap-filling">Level 4.1: Gap-filling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest">Random forest</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#features-predictors">Features (predictors)</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#nee-le-h">NEE, LE, H</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#fn2o-fch4">FN2O, FCH4</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-4-2-nee-partitioning-planned">Level 4.2: NEE Partitioning (planned)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#qcf-overall-quality-control-flag">QCF: overall quality control flag</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>